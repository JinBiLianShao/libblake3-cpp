# ğŸ“˜ BLAKE3 äº¤å‰ç¼–è¯‘ CMake æ„å»ºç³»ç»Ÿ
# ä½œè€…: è¿æ€é‘« (åŸºäºBLAKE3å®˜æ–¹CMakeé…ç½®ä¿®æ”¹)
# 
# æœ¬æ„å»ºç³»ç»Ÿä¸“ä¸ºç¼–è¯‘BLAKE3å“ˆå¸Œç®—æ³•åº“è®¾è®¡ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
#   âœ… ç¼–è¯‘BLAKE3 Cå®ç°ä¸ºé™æ€åº“æˆ–åŠ¨æ€åº“
#   âœ… è‡ªåŠ¨æ£€æµ‹å¹¶å¯ç”¨SIMDåŠ é€Ÿ (SSE4.1/AVX2/AVX512/NEON)
#   âœ… æ”¯æŒå¤šå¹³å°äº¤å‰ç¼–è¯‘ (x86/x64/arm32/arm64)
#   âœ… æ”¯æŒWindows (MinGW/MSVC) å’Œ Linux å¹³å°
#   âœ… å¯é€‰TBBå¹¶è¡Œè®¡ç®—æ”¯æŒ
#
# ğŸ“ ç›®å½•ç»“æ„è¦æ±‚ï¼š
#   blake3_project/
#   â”œâ”€â”€ CMakeLists.txt        (æ­¤æ–‡ä»¶)
#   â”œâ”€â”€ blake3/               # BLAKE3 Cæºç ç›®å½•
#   â”‚   â”œâ”€â”€ blake3.c
#   â”‚   â”œâ”€â”€ blake3.h
#   â”‚   â”œâ”€â”€ blake3_impl.h
#   â”‚   â”œâ”€â”€ blake3_dispatch.c
#   â”‚   â”œâ”€â”€ blake3_portable.c
#   â”‚   â””â”€â”€ ... (å…¶ä»–æºæ–‡ä»¶)
#   â”œâ”€â”€ build/                # æ„å»ºç›®å½•
#   â””â”€â”€ lib/                  # è¾“å‡ºåº“æ–‡ä»¶ç›®å½•
#
# ğŸ§© å¯é…ç½®é€‰é¡¹ï¼ˆé€šè¿‡å‘½ä»¤è¡Œä¼ å…¥ï¼‰ï¼š
#   -DCOMPILER_TARGET=x86|x64|arm32|arm64    # ç›®æ ‡å¹³å°æ¶æ„
#   -DTARGET_OS=linux|windows                 # ç›®æ ‡æ“ä½œç³»ç»Ÿ
#   -DTARGET_TYPE=static|shared               # ç›®æ ‡ç±»å‹ï¼šé™æ€åº“ / åŠ¨æ€åº“
#   -DENABLE_TBB=ON|OFF                       # æ˜¯å¦å¯ç”¨TBBå¹¶è¡Œè®¡ç®—
#   -DENABLE_ASSEMBLY=ON|OFF                  # æ˜¯å¦å¯ç”¨æ±‡ç¼–åŠ é€Ÿ (x64å¹³å°)
#   -DCMAKE_BUILD_TYPE=Release|Debug          # æ„å»ºç±»å‹
#
# âœ… æ„å»ºç¤ºä¾‹ï¼š
#   # Linux x64 é™æ€åº“
#   mkdir build && cd build
#   cmake .. -DCOMPILER_TARGET=x64 -DTARGET_OS=linux -DTARGET_TYPE=static
#   make -j
#
#   # Windows ARM64 åŠ¨æ€åº“ (ä½¿ç”¨MinGWäº¤å‰ç¼–è¯‘)
#   cmake .. -DCOMPILER_TARGET=arm64 -DTARGET_OS=windows -DTARGET_TYPE=shared
#
#   # Linux ARM32 é™æ€åº“ (å¸¦NEONåŠ é€Ÿ)
#   cmake .. -DCOMPILER_TARGET=arm32 -DTARGET_OS=linux -DTARGET_TYPE=static
####################################################################################################

cmake_minimum_required(VERSION 3.9)

# ---------------------------------------------------------------------------------------
# 1. é¡¹ç›®åŸºç¡€é…ç½®
# ---------------------------------------------------------------------------------------
project(libblake3 VERSION 1.8.3 LANGUAGES C ASM)

# è®¾ç½®æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# Cè¯­è¨€æ ‡å‡†è®¾ç½® (BLAKE3éœ€è¦C99)
set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_C_EXTENSIONS OFF)

# å¹³å°å’Œæ¶æ„é…ç½®
set(TARGET_OS "linux" CACHE STRING "Target OS: linux, windows")
set(COMPILER_TARGET "x64" CACHE STRING "Target architecture: x86, x64, arm32, arm64")
set(TARGET_TYPE "static" CACHE STRING "Build target type: static | shared")
option(ENABLE_TBB "Enable Intel TBB parallelism" OFF)
option(ENABLE_ASSEMBLY "Enable assembly optimizations (x64 only)" ON)

# æ ¹æ®ç›®æ ‡ç±»å‹è®¾ç½®åº“ç±»å‹
if(TARGET_TYPE STREQUAL "shared")
    set(BUILD_SHARED_LIBS ON CACHE BOOL "Build shared library" FORCE)
else()
    set(BUILD_SHARED_LIBS OFF CACHE BOOL "Build static library" FORCE)
endif()

# ---------------------------------------------------------------------------------------
# 2. ç¼–è¯‘å™¨ä¸äº¤å‰ç¼–è¯‘é…ç½®
# ---------------------------------------------------------------------------------------
# è®¾ç½®ç›®æ ‡ç³»ç»Ÿå¤„ç†å™¨ç±»å‹ (ç”¨äºBLAKE3çš„SIMDæ£€æµ‹)
if(COMPILER_TARGET STREQUAL "x64")
    set(CMAKE_SYSTEM_PROCESSOR "x86_64")
    set(BLAKE3_TARGET_ARCH "amd64")
elseif(COMPILER_TARGET STREQUAL "x86")
    set(CMAKE_SYSTEM_PROCESSOR "i686")
    set(BLAKE3_TARGET_ARCH "x86")
elseif(COMPILER_TARGET STREQUAL "arm64")
    set(CMAKE_SYSTEM_PROCESSOR "aarch64")
    set(BLAKE3_TARGET_ARCH "arm64")
elseif(COMPILER_TARGET STREQUAL "arm32")
    set(CMAKE_SYSTEM_PROCESSOR "arm")
    set(BLAKE3_TARGET_ARCH "arm")
endif()

message(STATUS "Building for ${TARGET_OS} ${COMPILER_TARGET} (${CMAKE_SYSTEM_PROCESSOR})")
message(STATUS "Library type: ${TARGET_TYPE}")
message(STATUS "TBB parallelism: ${ENABLE_TBB}")
message(STATUS "Assembly optimizations: ${ENABLE_ASSEMBLY}")

# ç¼–è¯‘å™¨é…ç½®
if(TARGET_OS STREQUAL "windows")
    # Windowså¹³å°é…ç½®
    if(CMAKE_HOST_SYSTEM_NAME MATCHES "Linux")
        # Linuxä¸‹äº¤å‰ç¼–è¯‘Windowsç›®æ ‡
        set(CMAKE_SYSTEM_NAME Windows)

        if(COMPILER_TARGET STREQUAL "x64")
            set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
            set(CMAKE_ASM_MASM_COMPILER x86_64-w64-mingw32-gcc)
        elseif(COMPILER_TARGET STREQUAL "x86")
            set(CMAKE_C_COMPILER i686-w64-mingw32-gcc)
            set(CMAKE_ASM_MASM_COMPILER i686-w64-mingw32-gcc)
        elseif(COMPILER_TARGET STREQUAL "arm64")
            set(CMAKE_C_COMPILER aarch64-w64-mingw32-gcc)
        endif()

        # Windowså®šä¹‰
        add_definitions(-DWIN32 -D_WIN32)

    else()
        # åŸç”ŸWindowsç¼–è¯‘ (MSVC)
        add_definitions(-DWIN32 -D_WIN32 -D_CRT_SECURE_NO_WARNINGS)
    endif()

else()
    # Linuxå¹³å°é…ç½®
    if(COMPILER_TARGET STREQUAL "arm64")
        set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
    elseif(COMPILER_TARGET STREQUAL "arm32")
        set(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc)
        # ARM32éœ€è¦æ˜¾å¼å¯ç”¨NEON
        add_compile_options(-mfpu=neon)
    elseif(COMPILER_TARGET STREQUAL "x64")
        set(CMAKE_C_COMPILER gcc)
    elseif(COMPILER_TARGET STREQUAL "x86")
        set(CMAKE_C_COMPILER gcc)
        add_compile_options(-m32)
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -m32")
        set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -m32")
    endif()
endif()

# ---------------------------------------------------------------------------------------
# 3. BLAKE3ä¸“ç”¨é…ç½®
# ---------------------------------------------------------------------------------------
# SIMDåŠ é€Ÿé…ç½®
if(ENABLE_ASSEMBLY AND COMPILER_TARGET STREQUAL "x64")
    if(TARGET_OS STREQUAL "windows")
        set(BLAKE3_SIMD_TYPE "amd64-asm")
    else()
        set(BLAKE3_SIMD_TYPE "amd64-asm")
    endif()
elseif(COMPILER_TARGET STREQUAL "x64" OR COMPILER_TARGET STREQUAL "x86")
    set(BLAKE3_SIMD_TYPE "x86-intrinsics")
elseif(COMPILER_TARGET STREQUAL "arm64")
    set(BLAKE3_SIMD_TYPE "neon-intrinsics")
elseif(COMPILER_TARGET STREQUAL "arm32")
    set(BLAKE3_SIMD_TYPE "neon-intrinsics")
else()
    set(BLAKE3_SIMD_TYPE "none")
endif()

message(STATUS "BLAKE3 SIMD acceleration: ${BLAKE3_SIMD_TYPE}")

# ç¼–è¯‘å™¨æ ‡å¿—è®¾ç½®
if(CMAKE_C_COMPILER_ID STREQUAL "GNU" OR CMAKE_C_COMPILER_ID STREQUAL "Clang" OR CMAKE_C_COMPILER_ID STREQUAL "AppleClang")
    # GCC/Clangç¼–è¯‘å™¨
    set(BLAKE3_CFLAGS_SSE2 "-msse2" CACHE STRING "Compiler flags for SSE2")
    set(BLAKE3_CFLAGS_SSE4_1 "-msse4.1" CACHE STRING "Compiler flags for SSE4.1")
    set(BLAKE3_CFLAGS_AVX2 "-mavx2" CACHE STRING "Compiler flags for AVX2")
    set(BLAKE3_CFLAGS_AVX512 "-mavx512f -mavx512vl" CACHE STRING "Compiler flags for AVX512")

    if(COMPILER_TARGET STREQUAL "arm32")
        set(BLAKE3_CFLAGS_NEON "-mfpu=neon" CACHE STRING "Compiler flags for NEON")
    endif()

elseif(MSVC)
    # MSVCç¼–è¯‘å™¨
    set(BLAKE3_CFLAGS_SSE2 "/arch:SSE2")
    set(BLAKE3_CFLAGS_SSE4_1 "/arch:AVX")  # MSVCæ²¡æœ‰ä¸“é—¨çš„SSE4.1æ ‡å¿—
    set(BLAKE3_CFLAGS_AVX2 "/arch:AVX2")
    set(BLAKE3_CFLAGS_AVX512 "/arch:AVX512")
endif()

# TBBé…ç½®
if(ENABLE_TBB)
    set(BLAKE3_USE_TBB ON CACHE BOOL "Enable TBB" FORCE)
    find_package(TBB QUIET)
    if(NOT TBB_FOUND)
        message(WARNING "TBB not found, disabling TBB support")
        set(ENABLE_TBB OFF)
        set(BLAKE3_USE_TBB OFF)
    endif()
else()
    set(BLAKE3_USE_TBB OFF)
endif()

# ---------------------------------------------------------------------------------------
# 4. æºæ–‡ä»¶é…ç½®
# ---------------------------------------------------------------------------------------
# BLAKE3æ ¸å¿ƒæºæ–‡ä»¶
set(BLAKE3_CORE_SOURCES
        blake3/blake3.c
        blake3/blake3_dispatch.c
        blake3/blake3_portable.c
        blake3/blake3.h
        blake3/blake3_impl.h
)

# æ ¹æ®SIMDç±»å‹æ·»åŠ é¢å¤–æºæ–‡ä»¶
if(BLAKE3_SIMD_TYPE STREQUAL "amd64-asm" AND ENABLE_ASSEMBLY)
    if(TARGET_OS STREQUAL "windows")
        set(BLAKE3_ASM_SOURCES
                blake3/blake3_avx2_x86-64_windows_gnu.S
                blake3/blake3_avx512_x86-64_windows_gnu.S
                blake3/blake3_sse2_x86-64_windows_gnu.S
                blake3/blake3_sse41_x86-64_windows_gnu.S
        )
    else()
        set(BLAKE3_ASM_SOURCES
                blake3/blake3_avx2_x86-64_unix.S
                blake3/blake3_avx512_x86-64_unix.S
                blake3/blake3_sse2_x86-64_unix.S
                blake3/blake3_sse41_x86-64_unix.S
        )
    endif()
    list(APPEND BLAKE3_CORE_SOURCES ${BLAKE3_ASM_SOURCES})

elseif(BLAKE3_SIMD_TYPE STREQUAL "x86-intrinsics")
    set(BLAKE3_INTRINSIC_SOURCES
            blake3/blake3_avx2.c
            blake3/blake3_avx512.c
            blake3/blake3_sse2.c
            blake3/blake3_sse41.c
    )
    list(APPEND BLAKE3_CORE_SOURCES ${BLAKE3_INTRINSIC_SOURCES})

elseif(BLAKE3_SIMD_TYPE STREQUAL "neon-intrinsics")
    set(BLAKE3_NEON_SOURCES
            blake3/blake3_neon.c
    )
    list(APPEND BLAKE3_CORE_SOURCES ${BLAKE3_NEON_SOURCES})
endif()

# æ·»åŠ TBBæºæ–‡ä»¶
if(ENABLE_TBB AND BLAKE3_USE_TBB)
    list(APPEND BLAKE3_CORE_SOURCES blake3/blake3_tbb.cpp)
endif()

# éªŒè¯æºæ–‡ä»¶å­˜åœ¨
foreach(SRC_FILE ${BLAKE3_CORE_SOURCES})
    if(NOT EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${SRC_FILE})
        message(WARNING "Source file not found: ${SRC_FILE}")
    endif()
endforeach()

# ---------------------------------------------------------------------------------------
# 5. åˆ›å»ºåº“ç›®æ ‡
# ---------------------------------------------------------------------------------------
if(BUILD_SHARED_LIBS)
    add_library(blake3 SHARED ${BLAKE3_CORE_SOURCES})
    target_compile_definitions(blake3
            PUBLIC BLAKE3_DLL
            PRIVATE BLAKE3_DLL_EXPORTS
    )
else()
    add_library(blake3 STATIC ${BLAKE3_CORE_SOURCES})
endif()

# è®¾ç½®ç›®æ ‡å±æ€§ - æ ¹æ®ç›®æ ‡å¹³å°è®¾ç½®æ­£ç¡®çš„åº“æ–‡ä»¶æ‰©å±•å
if(TARGET_OS STREQUAL "windows")
    # Windowså¹³å°å‘½åè§„åˆ™
    if(BUILD_SHARED_LIBS)
        # WindowsåŠ¨æ€åº“ï¼šblake3.dll
        set_target_properties(blake3 PROPERTIES
                VERSION ${PROJECT_VERSION}
                SOVERSION 0
                C_VISIBILITY_PRESET hidden
                OUTPUT_NAME "blake3"
                PREFIX ""  # å»æ‰é»˜è®¤çš„"lib"å‰ç¼€
                SUFFIX ".dll"  # ä½¿ç”¨.dllæ‰©å±•å
                IMPORT_SUFFIX ".dll.a"  # å¯¼å…¥åº“åç¼€
        )

        # åŒæ—¶ç”Ÿæˆå¯¼å…¥åº“ï¼ˆ.dll.aæ–‡ä»¶ï¼‰å’Œå®šä¹‰æ–‡ä»¶ï¼ˆ.defï¼‰
        if(CMAKE_C_COMPILER_ID STREQUAL "GNU")
            # MinGWéœ€è¦ç”Ÿæˆå¯¼å…¥åº“
            set_target_properties(blake3 PROPERTIES
                    WINDOWS_EXPORT_ALL_SYMBOLS OFF
                    DEFINE_SYMBOL BLAKE3_DLL_EXPORTS
            )
        endif()
    else()
        # Windowsé™æ€åº“ï¼šlibblake3.a (MinGW) æˆ– blake3.lib (MSVC)
        if(MSVC)
            set_target_properties(blake3 PROPERTIES
                    OUTPUT_NAME "blake3"
                    PREFIX ""
                    SUFFIX ".lib"
            )
        else()
            # MinGWé™æ€åº“
            set_target_properties(blake3 PROPERTIES
                    OUTPUT_NAME "blake3"
                    PREFIX "lib"
                    SUFFIX ".a"
            )
        endif()
    endif()
else()
    # Linuxå¹³å°å‘½åè§„åˆ™
    if(BUILD_SHARED_LIBS)
        # LinuxåŠ¨æ€åº“ï¼šlibblake3.so.1.8.3
        set_target_properties(blake3 PROPERTIES
                VERSION ${PROJECT_VERSION}
                SOVERSION 0
                C_VISIBILITY_PRESET hidden
                OUTPUT_NAME "blake3"
                PREFIX "lib"
                SUFFIX ".so"
        )
    else()
        # Linuxé™æ€åº“ï¼šlibblake3.a
        set_target_properties(blake3 PROPERTIES
                OUTPUT_NAME "blake3"
                PREFIX "lib"
                SUFFIX ".a"
        )
    endif()
endif()

# åŒ…å«ç›®å½•
target_include_directories(blake3 PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/blake3>
        $<INSTALL_INTERFACE:include>
)

# ç¼–è¯‘é€‰é¡¹
target_compile_features(blake3 PUBLIC c_std_99)

# SIMDæ–‡ä»¶ç¼–è¯‘æ ‡å¿—
if(BLAKE3_SIMD_TYPE STREQUAL "x86-intrinsics")
    if(DEFINED BLAKE3_CFLAGS_AVX2)
        set_source_files_properties(blake3/blake3_avx2.c PROPERTIES COMPILE_FLAGS "${BLAKE3_CFLAGS_AVX2}")
    endif()
    if(DEFINED BLAKE3_CFLAGS_AVX512)
        set_source_files_properties(blake3/blake3_avx512.c PROPERTIES COMPILE_FLAGS "${BLAKE3_CFLAGS_AVX512}")
    endif()
    if(DEFINED BLAKE3_CFLAGS_SSE2)
        set_source_files_properties(blake3/blake3_sse2.c PROPERTIES COMPILE_FLAGS "${BLAKE3_CFLAGS_SSE2}")
    endif()
    if(DEFINED BLAKE3_CFLAGS_SSE4_1)
        set_source_files_properties(blake3/blake3_sse41.c PROPERTIES COMPILE_FLAGS "${BLAKE3_CFLAGS_SSE4_1}")
    endif()
endif()

if(BLAKE3_SIMD_TYPE STREQUAL "neon-intrinsics" AND DEFINED BLAKE3_CFLAGS_NEON)
    set_source_files_properties(blake3/blake3_neon.c PROPERTIES COMPILE_FLAGS "${BLAKE3_CFLAGS_NEON}")
endif()

# TBBé“¾æ¥
if(ENABLE_TBB AND BLAKE3_USE_TBB)
    target_link_libraries(blake3 PUBLIC TBB::tbb)
    target_compile_definitions(blake3 PUBLIC BLAKE3_USE_TBB)

    # C++ç¼–è¯‘é€‰é¡¹ (TBBéœ€è¦C++æ–‡ä»¶)
    if(CMAKE_C_COMPILER_ID STREQUAL "GNU" OR CMAKE_C_COMPILER_ID STREQUAL "Clang")
        target_compile_options(blake3 PRIVATE $<$<COMPILE_LANGUAGE:CXX>:-fno-exceptions -fno-rtti>)
    elseif(MSVC)
        target_compile_options(blake3 PRIVATE $<$<COMPILE_LANGUAGE:CXX>:/EHs-c- /GR->)
    endif()
endif()

# ---------------------------------------------------------------------------------------
# 6. å®‰è£…é…ç½®
# ---------------------------------------------------------------------------------------
# å®‰è£…å¤´æ–‡ä»¶
install(FILES blake3/blake3.h DESTINATION include)

# å®‰è£…åº“æ–‡ä»¶
install(TARGETS blake3
        ARCHIVE DESTINATION lib
        LIBRARY DESTINATION lib
        RUNTIME DESTINATION bin
)

# ç”Ÿæˆå’Œå®‰è£…é…ç½®æ–‡ä»¶
include(CMakePackageConfigHelpers)
configure_package_config_file(
        ${CMAKE_CURRENT_SOURCE_DIR}/cmake/blake3-config.cmake.in
        ${CMAKE_CURRENT_BINARY_DIR}/blake3-config.cmake
        INSTALL_DESTINATION lib/cmake/blake3
)

write_basic_package_version_file(
        ${CMAKE_CURRENT_BINARY_DIR}/blake3-config-version.cmake
        VERSION ${PROJECT_VERSION}
        COMPATIBILITY SameMajorVersion
)

install(FILES
        ${CMAKE_CURRENT_BINARY_DIR}/blake3-config.cmake
        ${CMAKE_CURRENT_BINARY_DIR}/blake3-config-version.cmake
        DESTINATION lib/cmake/blake3
)

# ---------------------------------------------------------------------------------------
# 7. æ„å»ºä¿¡æ¯æ±‡æ€»
# ---------------------------------------------------------------------------------------
message(STATUS "------------------------------------------------")
message(STATUS " BLAKE3 Library Build Configuration")
message(STATUS "------------------------------------------------")
message(STATUS " Project Name:    ${PROJECT_NAME}")
message(STATUS " Version:         ${PROJECT_VERSION}")
message(STATUS " Target OS:       ${TARGET_OS}")
message(STATUS " Target Arch:     ${COMPILER_TARGET} (${CMAKE_SYSTEM_PROCESSOR})")
message(STATUS " Library Type:    ${TARGET_TYPE}")
message(STATUS " SIMD Acceleration: ${BLAKE3_SIMD_TYPE}")
message(STATUS " TBB Parallelism: ${ENABLE_TBB}")
message(STATUS " Build Type:      ${CMAKE_BUILD_TYPE}")
message(STATUS " Install Prefix:  ${CMAKE_INSTALL_PREFIX}")
message(STATUS " C Compiler:      ${CMAKE_C_COMPILER}")
message(STATUS " Source Files:    ${BLAKE3_CORE_SOURCES}")
message(STATUS "------------------------------------------------")